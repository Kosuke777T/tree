# SPEC.md — 家系図ソフト 確定仕様

> 本文書はdocs/design配下の全ドキュメントから抽出した**唯一の仕様**である。
> ドキュメント外の機能は追加しない。

---

## 1. プロダクト概要

| 項目 | 内容 |
|------|------|
| 名称 | tree（養豚家系図・系統評価ソフト） |
| 目的 | 母系家系図を可視化し、成績評価スコアで優秀系統を特定する |
| 形態 | Python デスクトップ GUI アプリ |
| Python | >= 3.13 |
| DB | SQLite（ローカルファイル） |

---

## 2. データソース（Excel 5 ファイル）

| # | ファイル | パス | カラム |
|---|---------|------|--------|
| 1 | 種付記録 | `data/種付記録/report.XLS` | 個体番号, 産歴, 種付日, 種付, ♂1回目, 再帰, 日齢, 状態/妊娠豚 |
| 2 | 分娩記録 | `data/分娩記録/report.XLS` | 個体番号, 産歴, 分娩日, 総産子, 生存, 死産, 黒子, +/-, 離乳日, 離乳, 死亡, 死亡率, 哺乳期間, 分娩間隔 |
| 3 | 死亡記録 | `data/死亡記録/report.XLS` | 個体番号, 淘汰日, 死亡原因1, 日齢, 産歴 |
| 4 | 廃豚記録 | `data/廃豚記録/report.XLS` | 個体番号, 淘汰日, 淘汰原因1, 非生産日数, 産歴 |
| 5 | 子豚記録 | `data/子豚記録/PS.xlsx` | 子豚№, 生年月日, ランク, 乳評価, 備考, 出荷先, PS出荷, 出荷日, 母親タトゥー, 父親タトゥー, 出荷日齢 |

---

## 3. ドメインルール（前提.txt より）

### 3.1 個体番号体系
- 子豚№は `A00001` 形式で始まる
- 母豚繰り上げ時、子豚№の先頭に `TB` を付与して個体番号とする
  - 例: `A00002` → `TBA00002`
- 子豚記録の「母親タトゥー」＝他記録の「個体番号」＝母豚番号

### 3.2 品種と交配
- 農場の母豚は全て**純粋種 W**
- 雄は全て人工授精（精液購入）、**W** と **L** の2種
- W交配 → 生まれた子豚（雌）は純粋種として繰り上げ可能
- L交配 → PS（F1）として販売候補

### 3.3 ランクと選抜
| ランク | 意味 | 父品種 |
|--------|------|--------|
| W | 純粋種（繰り上げ候補） | W |
| A | PS販売可能 | L |
| B | 選抜落ち | L |
| C | 選抜落ち | L |

### 3.4 乳評価（ランクAの場合のみ有効）
| 評価 | 意味 |
|------|------|
| 1 | 乳頭が綺麗 |
| 2 | 普通 |
| 3 | ぎりぎり販売可能 |

### 3.5 PS出荷区分
| 値 | 意味 |
|----|------|
| ○ | PSとして販売 |
| 肉 | 選抜落ち、肉豚として出荷 |
| W | 純粋種として繰り上げ → 母豚化 |

### 3.6 備考欄
- 空欄 = 問題なし
- 足・陰部などの記述 = 遺伝的欠点の可能性

### 3.7 退場判定
- 死亡記録・廃豚記録に存在する個体番号の母豚は**既に農場にいない**

---

## 4. 母豚成績評価ルール Ver.1（唯一の正）

### 4.1 里子(+/-)の定義
- `F > 0` : 里子をもらった（他母豚の子を受け入れ）
- `F < 0` : 里子を出した（自分の子を他母豚へ）

### 4.2 産歴別 基礎指標

| 指標 | 計算式 | 説明 |
|------|--------|------|
| OWN_W | `離乳(W) − 里子(F)` | 自分の子の離乳頭数（**最重要**） |
| OWN_RATE | `OWN_W ÷ W` | 自分の子比率（W=0は欠損） |
| LIVE_BORN | `生存` | 生存産子数 |
| TOTAL_BORN | `総産子` | 総産子数 |
| STILLBORN | `死産` | 死産数（少ないほど良い） |

### 4.3 産歴別 zスコア標準化

- **産歴 k ごと**に平均・標準偏差を算出
- `z = (値 − 産歴平均) ÷ 産歴SD`
- 死産のみ符号反転: `z_still = −(死産 − 平均) ÷ SD`

### 4.4 Shrinkage（縮小補正）

```
shrink = n ÷ (n + α)     α = 3（固定）
補正z = z × shrink
```
- `n` = その母豚の産歴回数

### 4.5 産歴スコア（重み固定）

| 指標 | 重み | 方向 |
|------|------|------|
| OWN_W | 0.45 | 多いほど良い |
| LIVE_BORN | 0.25 | 多いほど良い |
| TOTAL_BORN | 0.15 | 多いほど良い |
| STILLBORN | 0.10 | 少ないほど良い（反転済） |
| OWN_RATE | 0.05 | 高いほど良い（弱く） |

```
ParityScore_k =
    0.45 × z(OWN_W)
  + 0.25 × z(LIVE_BORN)
  + 0.15 × z(TOTAL_BORN)
  + 0.10 × z(STILLBORN反転)
  + 0.05 × z(OWN_RATE)
```
※ 全て Shrinkage 後の z を使用

### 4.6 母豚レベル 3軸評価

| 軸 | 計算 | 意味 |
|----|------|------|
| Peak | 産歴2〜3の ParityScore 平均 | ピーク性能 |
| Stability | ParityScore の分散 → 符号反転 | 安定性（バラつき少＝良） |
| Sustain | 後半平均 − 前半平均 | 持続力（落ちにくい＝良） |

### 4.6a OffspringQuality（子豚品質 — docs外追加指標）

> docs に定義がないため、以下の計算案で仮実装。重みは調整可能。

| 指標 | 定義 | 計算式 |
|------|------|--------|
| W_RATE | 純粋種(W)子豚のうち母豚繰り上げ率 | `count(dam=sow, ps_shipment='W') / count(dam=sow, rank='W')` |
| PS_RATE | L交配子豚のうちPS販売率 | `count(dam=sow, ps_shipment='○') / count(dam=sow, rank∈{A,B,C})` |

```
OffspringQuality = z(W_RATE) × 0.6 + z(PS_RATE) × 0.4
```

### 4.6b TotalScore（4軸統合）

```
TotalScore = Peak × 0.35 + Stability × 0.25 + Sustain × 0.25 + OffspringQuality × 0.15
```

### 4.7 順位付け（必須）
- **全頭順位**: 死亡・廃豚含む全母豚での TotalScore 順位
- **稼働母豚順位**: 現在農場にいる母豚のみでの TotalScore 順位

---

## 5. 画面構成（design/pedigree_sample より）

### 5.1 家系図ビュー（メイン画面）

- **方向**: 横型（左＝祖先、右＝子孫）
- **世代カラム**: 1世代目〜N世代目
- **接続線**:
  - 赤実線 = 母（母系接続）
  - 青点線 = 父（父系接続）
- **母系家系図**: 母系ラインを主軸として展開

### 5.2 ノード表示情報
- 個体番号
- 産歴数
- 成績スコア（TotalScore または ParityScore）
- ステータス（老齢母豚 / 死亡原因 / 淘汰理由 / 不受胎 等）

### 5.3 ノード強調
- スコア上位（優秀系統）のノードを色分けで強調表示

---

## 6. 系統評価（AI 優秀系統検出）

- 母系ライン単位で TotalScore を集約し、系統（母系血統）の優劣を判定
- 系統スコア = 同一母系ラインに属する母豚の TotalScore 集約値
- 家系図上で優秀系統を視覚的にハイライト

---

## 7. 対象外（実装しない）

- 精液管理・雄豚マスタの詳細管理（雄は識別文字列のみ保持）
- Webアプリ化
- 多農場対応
- ドキュメントに記載のない追加機能
